<title>post-like-comment-neta</title>

<style>
    /* body {
        background-color: whitesmoke;
    } */

    body {
        line-height: 17px;
        background-color: white;
    }

    h5 {
        margin-bottom: 0;
    }

    /*#like {*/
    /*    display: inline;*/
    /*}*/

    /*#like[data-voted="0"]::after {*/
    /*    content: attr(data-unvoted-text);*/
    /*}*/

    /*#like[data-voted="1"]::after {*/
    /*    content: attr(data-voted-text);*/
    /*}*/

    textarea {
        height: 1em;
        width: 20em;
    }

    .author {
        display: block;
        color: #666;
        font-size: 90%;
        margin-left: 1em;
    }

    .author::before {
        content: "by "
    }


    #comments div {
        margin: 1em 0;
    }

    #comments div::before {
        content: 'â†³';
        font-weight: bold;
    }

    #post {
        font-weight: bold;
        margin-bottom: 1em;
    }
</style>

<body>
    <article>
        <p>Test NetA</p>
        <span id="post">Added by script</span>
        <span id="postAuthor" class="author">5</span>
    </article>
    <div class="interactions">
        <h5>Comments:</h5>
        <textarea id="commentBox" oninput="updateHeight()"></textarea>
        <button id="comment" onclick="comment()">Send</button>

        <!--    <span id="likes">?</span>-->
        <!--    <button id="like" onclick="like()" data-voted-text="Unlike" data-unvoted-text="Like"></button>-->
    </div>
    <div id="comments"></div>
    <script>
        const post = document.getElementById("post")
        const postAuthor = document.getElementById("postAuthor")
        const comments = document.getElementById("comments")
        // const likeBtn = document.getElementById("like")
        const commentBox = document.getElementById("commentBox")
        const postID = -1


        window.tunnel.addEventListener('initialized', function () {
            const payload = window.tunnel.initialContent
            postAuthor.innerHTML = payload.username
            post.innerHTML = payload.content
            console.log(payload)
        });

        async function update(packet) {

            // postAuthor.innerHTML = packet.post.added_by
            updateComments(packet.comments)
        }

        // function hasLiked(content) {
        //     return content.interactions?.filter(inter => inter.actor === content.to)
        // }

        function updateComments(commentData) {
            comments.innerHTML = commentData?.map(comment =>
                `<div>${comment.post_body}<span class="author">${comment.posted_by}</span></div>`
            ).join("")
        }

        async function like() {
            update(await window.tunnel.sendInteraction(JSON.stringify({ like: true })))
        }

        async function comment() {
            fetch('http://localhost:8001/API/extComment.php',
                {
                    method: "post",
                    body: JSON.stringify({
                        post_id: "1",
                        commentator: "bob",
                        profile_url: "www.bob",
                        comment: commentBox.value
                    })
                }
            )

            commentBox.value = ""
            location.reload()

        }

        function updateHeight() {
            commentBox.style.height = Math.min(100, commentBox.scrollHeight - 7) + "px";
        }

        (async () =>
            update(await fetch('http://localhost:8001/API/outsideApi.php',
                {
                    method: "post",
                    body: JSON.stringify({
                        id: "1",
                        user: "bob"
                    })
                }
            ).then((response) => response.json()))
        )()


    </script>
</body>